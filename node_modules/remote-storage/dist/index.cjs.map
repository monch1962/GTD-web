{"version":3,"sources":["../src/index.ts","../src/core/remote-storage.ts","../src/core/utils.ts","../src/core/constants.ts"],"sourcesContent":["export { RemoteStorage } from './core/remote-storage'\nexport * from './core/constants'\n\nimport { RemoteStorage } from './core/remote-storage'\n\nglobalThis.RemoteStorage = RemoteStorage\n","import fetch from 'cross-fetch'\nimport { isWeb, uuid } from './utils'\nimport { HEADER_REMOTE_STORAGE_INSTANCE_ID, HEADER_REMOTE_STORAGE_USER_ID } from './constants'\n\nconst apiPrefix = `/entities/`\n\ninterface RemoteStorageConfig {\n  /**\n   * The server address to use for remote storage. Defaults to https://rs.frigade.com\n   */\n  serverAddress?: string\n  /**\n   * The user ID to use for remote storage. Defaults to a random UUID if not provided.\n   */\n  userId?: string\n  /**\n   * The instance ID to use for remote storage. Defaults to \"default\"\n   * Instance IDs are used to create a distinct namespace for your application and should not change for the same application.\n   */\n  instanceId?: string\n}\n\nexport class RemoteStorage {\n  private readonly serverAddress: string\n  private readonly instanceId: string\n  private readonly userId: string\n\n  constructor(config?: RemoteStorageConfig) {\n    const { serverAddress, instanceId, userId } = config ?? {}\n    this.serverAddress = serverAddress ?? 'https://api.remote.storage'\n    this.instanceId = instanceId ?? 'default'\n    this.userId = userId ?? this.getUserId()\n  }\n\n  /**\n   * Get an item from remote storage\n   * @param key the key that corresponds to the item to get\n   * @param fetchOptions optional fetch options to pass to the underlying fetch call. Currently only headers for authorization are supported.\n   */\n  async getItem<T>(key: string, fetchOptions?: any): Promise<T> {\n    const response = await this.call('GET', `${apiPrefix}${key}`, fetchOptions, null)\n    // Check for 404 and return null if so\n    if (response.status === 404) {\n      return null\n    }\n    const data = await response.text()\n    // Check if valid JSON\n    if (!data.startsWith('{') && !data.startsWith('[')) {\n      if (data === 'true') {\n        return true as unknown as T\n      }\n      if (data === 'false') {\n        return false as unknown as T\n      }\n      if (!isNaN(Number(data))) {\n        return Number(data) as unknown as T\n      }\n\n      return data as T\n    }\n    return JSON.parse(data) as T\n  }\n\n  /**\n   * Set an item in remote storage\n   * @param key the key that corresponds to the item to set\n   * @param value the value to set\n   * @param fetchOptions optional fetch options to pass to the underlying fetch call. Currently only headers for authorization are supported.\n   */\n  async setItem<T>(key: string, value: T, fetchOptions?: any): Promise<void> {\n    await this.call('PUT', `${apiPrefix}${key}`, fetchOptions, value)\n  }\n\n  /**\n   * Remove an item from remote storage\n   * @param key the key that corresponds to the item to remove\n   * @param fetchOptions optional fetch options to pass to the underlying fetch call. Currently only headers for authorization are supported.\n   */\n  async removeItem(key: string, fetchOptions?: any): Promise<void> {\n    await this.call('DELETE', `${apiPrefix}${key}`, fetchOptions, null)\n  }\n\n  async call(method: string, path: string, options?: any, data?: any) {\n    return fetch(new URL(path, this.serverAddress).toString(), {\n      method: method,\n      headers: {\n        'Content-Type': 'application/json',\n        [HEADER_REMOTE_STORAGE_INSTANCE_ID]: this.instanceId,\n        [HEADER_REMOTE_STORAGE_USER_ID]: this.userId,\n        ...options?.headers,\n      },\n      body: data ? JSON.stringify(data) : undefined,\n    })\n  }\n\n  private getUserId(): string | null {\n    const key = `rs-user-id`\n    if (isWeb()) {\n      if (window.localStorage.getItem(key)) {\n        return window.localStorage.getItem(key)\n      }\n    }\n    const userId = uuid()\n    if (isWeb()) {\n      window.localStorage.setItem(key, userId)\n    }\n    return userId\n  }\n}\n","export function uuid() {\n  let d = new Date().getTime(),\n    d2 = (typeof performance !== 'undefined' && performance.now && performance.now() * 1000) || 0\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, (c) => {\n    let r = Math.random() * 16\n    if (d > 0) {\n      r = (d + r) % 16 | 0\n      d = Math.floor(d / 16)\n    } else {\n      r = (d2 + r) % 16 | 0\n      d2 = Math.floor(d2 / 16)\n    }\n    return (c == 'x' ? r : (r & 0x7) | 0x8).toString(16)\n  })\n}\n\nexport function isWeb() {\n  return typeof window !== 'undefined'\n}\n","export const HEADER_REMOTE_STORAGE_INSTANCE_ID = 'x-remote-storage-instance-id'\nexport const HEADER_REMOTE_STORAGE_USER_ID = 'x-remote-storage-user-id'\n"],"mappings":"6iBAAA,IAAAA,EAAA,GAAAC,EAAAD,EAAA,uCAAAE,EAAA,kCAAAC,EAAA,kBAAAC,IAAA,eAAAC,EAAAL,GCAA,IAAAM,EAAkB,4BCAX,SAASC,GAAO,CACrB,IAAIC,EAAI,IAAI,KAAK,EAAE,QAAQ,EACzBC,EAAM,OAAO,YAAgB,KAAe,YAAY,KAAO,YAAY,IAAI,EAAI,KAAS,EAC9F,MAAO,uCAAuC,QAAQ,QAAUC,GAAM,CACpE,IAAIC,EAAI,KAAK,OAAO,EAAI,GACxB,OAAIH,EAAI,GACNG,GAAKH,EAAIG,GAAK,GAAK,EACnBH,EAAI,KAAK,MAAMA,EAAI,EAAE,IAErBG,GAAKF,EAAKE,GAAK,GAAK,EACpBF,EAAK,KAAK,MAAMA,EAAK,EAAE,IAEjBC,GAAK,IAAMC,EAAKA,EAAI,EAAO,GAAK,SAAS,EAAE,CACrD,CAAC,CACH,CAEO,SAASC,GAAQ,CACtB,OAAO,OAAO,OAAW,GAC3B,CClBO,IAAMC,EAAoC,+BACpCC,EAAgC,2BFG7C,IAAMC,EAAY,aAkBLC,EAAN,KAAoB,CAKzB,YAAYC,EAA8B,CACxC,GAAM,CAAE,cAAAC,EAAe,WAAAC,EAAY,OAAAC,CAAO,EAAIH,GAAU,CAAC,EACzD,KAAK,cAAgBC,GAAiB,6BACtC,KAAK,WAAaC,GAAc,UAChC,KAAK,OAASC,GAAU,KAAK,UAAU,CACzC,CAOA,MAAM,QAAWC,EAAaC,EAAgC,CAC5D,IAAMC,EAAW,MAAM,KAAK,KAAK,MAAO,GAAGR,IAAYM,IAAOC,EAAc,IAAI,EAEhF,GAAIC,EAAS,SAAW,IACtB,OAAO,KAET,IAAMC,EAAO,MAAMD,EAAS,KAAK,EAEjC,MAAI,CAACC,EAAK,WAAW,GAAG,GAAK,CAACA,EAAK,WAAW,GAAG,EAC3CA,IAAS,OACJ,GAELA,IAAS,QACJ,GAEJ,MAAM,OAAOA,CAAI,CAAC,EAIhBA,EAHE,OAAOA,CAAI,EAKf,KAAK,MAAMA,CAAI,CACxB,CAQA,MAAM,QAAWH,EAAaI,EAAUH,EAAmC,CACzE,MAAM,KAAK,KAAK,MAAO,GAAGP,IAAYM,IAAOC,EAAcG,CAAK,CAClE,CAOA,MAAM,WAAWJ,EAAaC,EAAmC,CAC/D,MAAM,KAAK,KAAK,SAAU,GAAGP,IAAYM,IAAOC,EAAc,IAAI,CACpE,CAEA,MAAM,KAAKI,EAAgBC,EAAcC,EAAeJ,EAAY,CAClE,SAAO,EAAAK,SAAM,IAAI,IAAIF,EAAM,KAAK,aAAa,EAAE,SAAS,EAAG,CACzD,OAAQD,EACR,QAAS,CACP,eAAgB,mBAChB,CAACI,CAAiC,EAAG,KAAK,WAC1C,CAACC,CAA6B,EAAG,KAAK,OACtC,GAAGH,GAAA,YAAAA,EAAS,OACd,EACA,KAAMJ,EAAO,KAAK,UAAUA,CAAI,EAAI,MACtC,CAAC,CACH,CAEQ,WAA2B,CACjC,IAAMH,EAAM,aACZ,GAAIW,EAAM,GACJ,OAAO,aAAa,QAAQX,CAAG,EACjC,OAAO,OAAO,aAAa,QAAQA,CAAG,EAG1C,IAAMD,EAASa,EAAK,EACpB,OAAID,EAAM,GACR,OAAO,aAAa,QAAQX,EAAKD,CAAM,EAElCA,CACT,CACF,EDvGA,WAAW,cAAgBc","names":["src_exports","__export","HEADER_REMOTE_STORAGE_INSTANCE_ID","HEADER_REMOTE_STORAGE_USER_ID","RemoteStorage","__toCommonJS","import_cross_fetch","uuid","d","d2","c","r","isWeb","HEADER_REMOTE_STORAGE_INSTANCE_ID","HEADER_REMOTE_STORAGE_USER_ID","apiPrefix","RemoteStorage","config","serverAddress","instanceId","userId","key","fetchOptions","response","data","value","method","path","options","fetch","HEADER_REMOTE_STORAGE_INSTANCE_ID","HEADER_REMOTE_STORAGE_USER_ID","isWeb","uuid","RemoteStorage"]}